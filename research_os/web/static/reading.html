<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResearchOS Reading Mode</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scroll-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [papers, setPapers] = useState([]);
            const [selectedPaper, setSelectedPaper] = useState(null);
            const [chatOpen, setChatOpen] = useState(true);
            const [messages, setMessages] = useState([{ role: 'system', content: 'Select a paper to start reading with AI Copilot.' }]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [useCloud, setUseCloud] = useState(false);
            const [searchOpen, setSearchOpen] = useState(false);
            const [activeStream, setActiveStream] = useState("");
            const ws = useRef(null);

            // Fetch papers on load
            const refreshLibrary = () => {
                fetch('/api/papers')
                    .then(res => res.json())
                    .then(data => setPapers(data))
                    .catch(err => console.error(err));
            };
            useEffect(refreshLibrary, []);

            // WS Connection
            useEffect(() => {
                ws.current = new WebSocket(`ws://${window.location.host}/ws/chat`);
                ws.current.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'token') {
                        setMessages(prev => {
                            const last = prev[prev.length - 1];
                            if (last.role === 'ai' && last.pending) {
                                return [...prev.slice(0, -1), { ...last, content: last.content + data.content }];
                            } else if (last.role === 'ai') {
                                // Shouldn't happen if logic is right, but safe guard
                                return [...prev.slice(0, -1), { ...last, content: last.content + data.content }];
                            }
                            return [...prev, { role: 'ai', content: data.content, pending: true }];
                        });
                    } else if (data.type === 'done') {
                        setLoading(false);
                        setMessages(prev => {
                            const last = prev[prev.length - 1];
                            return [...prev.slice(0, -1), { ...last, pending: false }];
                        });
                    }
                };
                return () => ws.current.close();
            }, []);

            const selectPaper = (paper) => {
                setSelectedPaper(paper);
                setMessages([{ role: 'system', content: `Reading: ${paper.title}. Ask me anything about it.` }]);
            };

            const sendMessage = (e) => {
                e.preventDefault();
                if (!input.trim()) return;

                const userMsg = input;
                setMessages(prev => [...prev, { role: 'user', content: userMsg }]);
                setMessages(prev => [...prev, { role: 'ai', content: "", pending: true }]); // Placeholder
                setInput("");
                setLoading(true);

                if (ws.current) {
                    ws.current.send(JSON.stringify({
                        prompt: userMsg,
                        context: selectedPaper ? `Paper: ${selectedPaper.title}. Abstract: ${selectedPaper.abstract || ''}` : "",
                        use_cloud: useCloud
                    }));
                }
            };

            // Search Logic
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            const [searching, setSearching] = useState(false);

            const handleSearch = async () => {
                setSearching(true);
                try {
                    const res = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: searchQuery })
                    });
                    setSearchResults(await res.json());
                } catch (e) { console.error(e); }
                setSearching(false);
            };

            const ingestPaper = async (paper) => {
                try {
                    await fetch('/api/ingest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(paper)
                    });
                    setSearchOpen(false);
                    refreshLibrary();
                    setSearchResults([]);
                    setSearchQuery("");
                } catch (e) { console.error(e); }
            };

            return (
                <div className="flex h-screen w-screen bg-slate-900">
                    {/* Sidebar Navigation */}
                    <div className="w-16 flex flex-col items-center py-4 bg-slate-950 border-r border-slate-800 z-50">
                        <div className="mb-8 font-bold text-blue-500">ROS</div>
                        <a href="/" className="p-3 mb-2 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg></a>
                        <a href="/reading" className="p-3 mb-2 rounded-xl bg-blue-600 text-white shadow-lg shadow-blue-500/20"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></a>
                        <a href="/graph" className="p-3 mb-2 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg></a>
                    </div>

                    {/* Library Sidebar */}
                    <div className="w-64 glass flex flex-col border-r border-slate-700">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                            <div>
                                <h2 className="font-bold text-slate-200">Library</h2>
                                <p className="text-xs text-slate-400">{papers.length} papers</p>
                            </div>
                            <button onClick={() => setSearchOpen(true)} className="p-1 bg-slate-700 rounded hover:bg-slate-600 text-white">+</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1 scroll-hide">
                            {papers.map((p, i) => (
                                <button key={i} onClick={() => selectPaper(p)} className={`w-full text-left p-3 rounded-lg text-sm transition-all ${selectedPaper?.path === p.path ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800'}`}>
                                    <div className="font-medium truncate">{p.title}</div>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex relative">
                        {/* PDF Viewer */}
                        <div className={`flex-1 bg-slate-800 relative transition-all duration-300 ${chatOpen ? 'w-2/3' : 'w-full'}`}>
                            {selectedPaper ? (
                                <iframe src={`/api/papers/pdf?path=${encodeURIComponent(selectedPaper.path)}`} className="w-full h-full border-none" />
                            ) : (
                                <div className="flex items-center justify-center h-full text-slate-500">Select a paper to read</div>
                            )}
                        </div>

                        {/* Copilot Sidebar */}
                        {chatOpen && (
                            <div className="w-96 bg-slate-900 border-l border-slate-800 flex flex-col shadow-2xl relative z-40">
                                <div className="p-4 border-b border-slate-800 bg-slate-900/50 backdrop-blur">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-slate-200">Copilot</h3>
                                        <button onClick={() => setChatOpen(false)} className="text-slate-400 hover:text-white">âœ•</button>
                                    </div>
                                    <div className="flex items-center space-x-2 text-xs">
                                        <span className={useCloud ? "text-slate-500" : "text-green-400 font-bold"}>Local (Phi-3)</span>
                                        <div
                                            className={`w-8 h-4 bg-slate-700 rounded-full relative cursor-pointer transition-colors ${useCloud ? 'bg-purple-900' : 'bg-slate-700'}`}
                                            onClick={() => setUseCloud(!useCloud)}
                                        >
                                            <div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all ${useCloud ? 'left-4' : 'left-0.5'}`}></div>
                                        </div>
                                        <span className={useCloud ? "text-purple-400 font-bold" : "text-slate-500"}>Cloud (Groq 70B)</span>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] rounded-2xl px-4 py-2 text-sm ${m.role === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-200'} whitespace-pre-wrap`}>
                                                {m.content}
                                                {m.pending && <span className="inline-block w-1.5 h-4 ml-1 align-middle bg-slate-400 animate-pulse"></span>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 border-t border-slate-800">
                                    <form onSubmit={sendMessage}>
                                        <input value={input} onChange={e => setInput(e.target.value)} placeholder="Ask about this paper..." className="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-1 focus:ring-blue-500" />
                                    </form>
                                </div>
                            </div>
                        )}
                        {!chatOpen && <button onClick={() => setChatOpen(true)} className="absolute right-4 bottom-4 p-3 bg-blue-600 rounded-full text-white shadow-lg transition-all hover:scale-105 z-50">ðŸ’¬</button>}
                    </div>

                    {/* Search Modal */}
                    {searchOpen && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center">
                            <div className="bg-slate-900 border border-slate-700 w-[600px] max-h-[80vh] rounded-2xl flex flex-col shadow-2xl">
                                <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                                    <h3 className="font-bold text-white">Add Papers from ArXiv</h3>
                                    <button onClick={() => setSearchOpen(false)} className="text-slate-400 hover:text-white">âœ•</button>
                                </div>
                                <div className="p-4 border-b border-slate-800 flex space-x-2">
                                    <input value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Search papers..." className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white" />
                                    <button onClick={handleSearch} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">{searching ? '...' : 'Search'}</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {searchResults.map((p, i) => (
                                        <div key={i} className="bg-slate-800 p-3 rounded-lg border border-slate-700 flex justify-between items-start group hover:border-blue-500 transition-colors">
                                            <div>
                                                <div className="font-bold text-slate-200">{p.title}</div>
                                                <div className="text-xs text-slate-400 mt-1">{p.authors?.[0]} â€¢ {p.published}</div>
                                            </div>
                                            <button onClick={() => ingestPaper(p)} className="bg-slate-700 hover:bg-green-600 text-slate-300 hover:text-white px-3 py-1 rounded text-xs transition-colors">+ Add</button>
                                        </div>
                                    ))}
                                    {searchResults.length === 0 && !searching && <div className="text-center text-slate-500 py-10">Search for PDFs to add to your library.</div>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>